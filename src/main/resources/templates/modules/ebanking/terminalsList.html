<div layout:fragment="pageStyle" th:remove="tag">
    <style>
        #loading {
            background: url('/assets/images/ajax-loader.gif') no-repeat center center;
            position: absolute;
            top: 0;
            left: 0;
            height: 92%;
            width: 100%;
            z-index: 9999999;
        }
        .btn {
            border-radius: 0px !important;
        }
        .btn-dark {
            background-color: #107f13!important;
            border: 1px solid #ffffff!important;
        }
        .wor {
            margin: 10px;
            display: flex;
        }
        .col-md-2, .col-md-3 {
            align-self: center;
        }
        label {
            margin: auto !important;
        }
        #accountDetails, #addTerminalForm {
            display: none;
        }
        fieldset {
            display: block;
            margin-inline-start: 2px;
            margin-inline-end: 2px;
            padding-block-start: 0.35em;
            padding-inline-start: 0.75em;
            padding-inline-end: 0.75em;
            padding-block-end: 0.625em;
            min-inline-size: min-content;
            border: 1px solid silver;
        }
        fieldset .row {
            margin: auto;
            padding: inherit;
        }
        legend {
            width: unset;
        }
        .select2-container--default .select2-selection--single {
            border: 1px solid #dcdcdc !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #999;
        }
    </style>
    <link th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/select2/css/select2.min.css}" rel="stylesheet" type="text/css" />
</div>
<div class="panel panel-default panel-fill">
    <div class="panel-heading">
        <h4 class="panel-title">POS TERMINALS</h4>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-md-12" id="successFlag"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form class="form-horizontal" role="form" id="searchAccountForm">
                    <div class="row wor">
                        <div class="col-md-2">
                            <label for="accountNo">Enter Account No</label>
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="accountNo" id="accountNo" autocomplete="off" th:required="true"
                                   class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="ACCOUNT NUMBER">
                        </div>
                        <div class="col-md-3">
                            <button id="get-account" type="button" class="btn btn-primary">Search</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="accountDetails"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form class="form-horizontal" role="form" id="addTerminalForm">
                    <fieldset>
                        <legend>ENTER TERMINAL DETAILS:</legend>
                        <div class="row">
                            <div class="col-md-2">
                                <label for="terminalId">Enter Terminal No</label>
                            </div>
                            <div class="col-md-4">
                                <input type="text" name="terminalId" id="terminalId" autocomplete="off" th:required="true"
                                       class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="TERMINAL NUMBER">
                            </div>
                        </div>
                        <!--                        <div class="row">-->
                        <!--                            <div class="col-md-2">-->
                        <!--                                <label for="phone">Enter Phone Number</label>-->
                        <!--                            </div>-->
                        <!--                            <div class="col-md-4">-->
                        <!--                                <input type="tel" maxlength="12" name="phone" id="phone" autocomplete="off" th:required="true"-->
                        <!--                                       class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="PHONE">-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                        <div class="row">
                            <div class="col-md-2">
                                <label for="role">Select Role</label>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control col-sm-12 select2" id="role" name="role" style="font-size: 10px !important;" th:required="true">
                                    <option value="">Select Role</option>
                                    <option th:each="role: ${roles}" th:value="${role.id}" th:text="${role.name}">
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6" style="text-align: center">
                                <button id="save-terminal" type="button" class="btn btn-primary">Add Terminal</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form role="form">
                    <div class="row wor">
                        <div class="form-group col-md-3">
                            <label>Select Date</label>
                            <div class="input-group">
                                <input name="createdDate" class="form-control form-control-inline input-medium default-date-picker"  id="datepicker-autoclose" data-date-format="yyyy-mm-dd" type="text" placeholder="yyyy-mm-dd" autocomplete="off"/>
                                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
                            </div><!-- input-group -->
                        </div>
                        <div class="form-group col-md-3">
                            <label>From Time</label>
                            <div class="input-group">
                                <input id="fromTime" name="fromTime" type="text" class="form-control">
                                <span class="input-group-addon"><i class="mdi mdi-clock"></i></span>
                            </div><!-- input-group -->
                        </div>
                        <div class="form-group col-md-3">
                            <label>To Time</label>
                            <div class="input-group">
                                <input id="toTime" name ="toTime" type="text" class="form-control">
                                <span class="input-group-addon"><i class="mdi mdi-clock"></i></span>
                            </div><!-- input-group -->
                        </div>
                        <div class="form-group col-md-3 m-b-0" style="align-self: center;">
                            <button  type="button" class="btn btn-primary">Search</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-3">
                            <button type="button" id="all" class="btn btn-primary">All Terminals</button>
                        </div>
                        <div class="form-group col-md-3">
                            <button type="button" id="locked" class="btn btn-warning">Locked Accounts</button>
                        </div>
                        <div class="form-group col-md-3">
                            <button type="button" id="blocked" class="btn btn-danger">Blocked Terminals</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="loading" hidden></div>
                <table id="terminalsTable" class="display nowrap table table-striped table-bordered" style="width: 100%; font-size: 8.5px !important;">
                    <thead>
                    <tr>
                        <th>S/N</th>
                        <th>Created By</th>
                        <th>Device ID</th>
                        <th>Device Name</th>
                        <th>Terminal No</th>
                        <th>Phone No</th>
                        <th>Account</th>
                        <th>Locked</th>
                        <th>Blocked</th>
                        <th>Remarks</th>
                        <th>App Version</th>
                        <th>No. of skipped app updates</th>
                        <th>Failed attempts</th>
                        <th>First login</th>
                        <th>TIN</th>
                        <th>Region</th>
                        <th>District</th>
                        <th>Ward</th>
                        <th>Town</th>
                        <th>Location</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div layout:fragment="pageScript" th:remove="tag">
    <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
    <!--init-->
    <script th:src="@{/assets/pages/jquery.datatables.init.js}"></script>
    <script th:src="@{/assets/plugins/moment/moment.js}"></script>
    <script th:src="@{/assets/plugins/timepicker/bootstrap-timepicker.js}"></script>
    <script th:src="@{/assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
    <!--App Js-->
    <script th:src="@{/assets/js/jquery.app.js}"></script>
    <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>
    <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
    <script type="text/javascript" th:inline="javascript">
        $(document).ready(function () {
            var lockedAccounts = false;
            var blockedAccounts = false;
            $('#fromTime').timepicker({
                showMeridian: false
            });
            $('#toTime').timepicker({
                showMeridian: false
            });
            $('#datepicker-autoclose').datepicker({
                autoclose: true,
                todayHighlight: true
            });
            $('#locked').on().click(function () {
                lockedAccounts = true;
                blockedAccounts = false;
                $('#terminalsTable').DataTable().ajax.reload();
            });
            $('#blocked').on().click(function () {
                blockedAccounts = true;
                lockedAccounts = false;
                $('#terminalsTable').DataTable().ajax.reload();
            });
            $('#all').on().click(function () {
                lockedAccounts = false;
                blockedAccounts = false;
                $('#terminalsTable').DataTable().ajax.reload();
            });
            $(".select2").select2();
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var b = 1;
            var i = 0;
            var table = $('#terminalsTable').DataTable({
                dom: 'Blfrtip',
                lengthChange: true,
                scrollCollapse: true,
                scrollY: "700px",
                scrollX: true,
                pageLength: 10,
                lengthMenu: [
                    [5, 10, 25, 50, 100, 500,10000,25000,50000, -1],
                    [5, 10, 25, 50, 100, 500,10000,25000,50000, 'Show all']
                ],
                responsive: false,
                processing: true,
                serverSide: true,
                serverMethod: 'post',
                order: [1, "desc"],
                ajax: {
                    'url': /*[[@{/getTerminalsAjax}]]*/,
                    'beforeSend': function (request) {
                        request.setRequestHeader(header, token);
                    },
                    "data": function (d) {
                        return $.extend({}, d, {
                            "createdDate": $("input[name='createdDate']").val(),
                            "fromTime": $("input[name='fromTime']").val(),
                            "toTime": $("input[name='toTime']").val(),
                            "locked": lockedAccounts,
                            "blocked": blockedAccounts
                        });
                    }
                },
                "columns": [
                    {"data": "id"},
                    {"data": "created_by"},
                    {"data": "deviceId"},
                    {"data": "deviceName"},
                    {"data": "username"},
                    {"data": "phone"},
                    {"data": "account"},
                    {
                        "data": "accountNoLocked",
                        "orderable": true,
                        "searchable": true,
                        "render": function (data, type, row, meta) {
                            if (!row.accountNoLocked)
                                return "Yes";
                            else
                                return "No";
                        }
                    },
                    {
                        "data": "enabled",
                        "orderable": true,
                        "searchable": true,
                        "render": function (data, type, row, meta) {
                            if (!row.enabled)
                                return "Yes";
                            else
                                return "No";
                        }
                    },
                    {"data": "remarks"},
                    {"data": "appVersion"},
                    {"data": "noOfSkippedAppUpdates"},
                    {"data": "failedAttempt"},
                    {"data": "firstLogin"},
                    {"data": "tin"},
                    {"data": "region"},
                    {"data": "district"},
                    {"data": "ward"},
                    {"data": "town"},
                    {"data": "location"},
                    {"data": "latitude"},
                    {"data": "longitude"},
                    {
                        "data": "id",
                        "orderable": false,
                        "searchable": false,
                        "render": function (data, type, row, meta) {
                            var a = '<button type="button" class="btn btn-primary" onclick="openEditModal(\'' +
                             row.id + '\',\'' +
                             row.username + '\',\'' +
                             row.account + '\',\'' +
                             row.firstname + '\',\'' +
                             row.middlename + '\',\'' +
                             row.lastname + '\',\'' +
                             row.phone + '\',\'' +
                             row.email + '\',\'' +
                             row.appversion + '\',\'' +
                             row.tin + '\',\'' +
                             row.region + '\',\'' +
                             row.district + '\',\'' +
                             row.ward + '\',\'' +
                             row.town + '\',\'' +
                             row.location + '\',\'' +
                             row.latitude + '\',\'' +
                             row.longitude + '\')"><i class="fa fa-edit"></i>Edit</button>';
                            a += '&nbsp;&nbsp;<button type="button" class="btn btn-primary" onclick="openTerminalRoleDialog(\'' +
                             row.id + '\')"><i class="fa fa-edit"></i>Role</button>';
                            if (!row.accountNoLocked)
                                a += '&nbsp;&nbsp;<button type="button" class="btn btn-primary" onclick="unlockTerminal(\'' + row.id + '\')">Unlock</button>';
                            a += '&nbsp;&nbsp;<button type="button" class="btn btn-primary" onclick="resetPassword(\'' + row.id + '\',\'' + row.phone + '\')">Reset</button>';
                            if (row.enabled)
                                a += '&nbsp;&nbsp;<button type="button" class="btn btn-primary" onclick="terminalStatus(\'' + row.id + '\',\'' + row.phone + '\',' + row.enabled + ')">Block</button>';
                            else
                                a += '&nbsp;&nbsp;<button type="button" class="btn btn-primary" onclick="terminalStatus(\'' + row.id + '\',\'' + row.phone + '\',' + row.enabled + ')">Unblock</button>';
                            return a;
                        }
                    }
                ],
                aoColumnDefs: [{
                        bSortable: false,
                        aTargets: [-1],
                }],
                columnDefs: [
                    {width: 1000, targets: 14}
                ],
                buttons: [
                    {
                        extend: "copy",
                        title: 'POS TERMINALS',
                        className: "btn-sm"
                    }, {
                        extend: "csv",
                        title: 'POS TERMINALS',
                        className: "btn-sm"
                    }, {
                        extend: "excel",
                        title: 'POS TERMINALS',
                        className: "btn-sm"
                    }, {
                        extend: "pdf",
                        title: 'POS TERMINALS',
                        className: "btn-sm"
                    }, {
                        extend: "print",
                        title: 'POS TERMINALS',
                        className: "btn-sm"
                    }
                ],
                "createdRow": function (row, data, index) {
                    if (!data.accountNoLocked) {
                        $(row).css("background-color","#ffd600");
                        $(row).css("color","black");
                    } else if (!data.enabled) {
                        $(row).css("background-color","#ff6666");
                        $(row).css("color","white");
                    }
                }
            });
            table.on('order.dt search.dt', function () {
                table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();


            /*
             * SEARCH ACCOUNT
             */
            $('#get-account').click(function (e) {
                if ($('#accountNo').val().length >= 12) {
                    $("#loading").show();
                    $('#successFlag').hide();
                    $('#accountDetails').hide();
                    $('#addTerminalForm').hide();
                    var formData = new FormData($('#searchAccountForm')[0]);
                    $.ajax({
                        url: "/searchAccount",
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: "json",
                        success: function (res) {
                            $('.error').html('');
                            $('#loading').hide();
                            $('#accountDetails').show();
                            $('#successFlag').show();
                            if (res.result == 0) {
                                localStorage.setItem("account", JSON.stringify(res.account));
                                $('#accountDetails').html('<p><strong>Account Name: </strong><b>'+res.account.accountName+'</b></p>'
                                + '<p><strong>Account Type: </strong><b>'+res.account.accountType+'</b></p>'
                                + '<p><strong>Branch: </strong><b>'+res.account.branch.buName+' ('+res.account.branch.buCode+')</b></p>'
                                + '<p><strong>Branch status: </strong><b>'+res.account.branch.status+'</b></p>'
                                + '<p><strong>Currency: </strong><b>'+res.account.currency.name+' ('+res.account.currency.code+')</b></p>'
                                + '<p><strong>Customer category: </strong><b>'+res.account.custCat+'</b></p>'
                                );
                                $('#addTerminalForm').show();
                            } else {
                                $('#successFlag').html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"></button><strong>'+res.message+'</strong></div>');
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            console.log(res);
                            $("#loading").hide();
                            $('#successFlag').show();
                            $('#successFlag').html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"></button><strong>'+thrownError+'</strong></div>');
                        }
                    });
                } else {
                    $('#successFlag').show();
                    $('#successFlag').html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"></button><strong>Enter a valid account number!</strong></div>');
                }
            });


            /*
             * ADD NEW TERMINAL
             */
            $('#save-terminal').click(function (e) {
                var formData = new FormData($('#addTerminalForm')[0]);
                //var phoneNo = formData.get("phone");
                var terminalId = formData.get("terminalId");
                var role = formData.get("role");
                var errorMsgs = '';
                //if (phoneNo.length == 0 || !(phoneNo.length == 12 || phoneNo.length == 10)) {
                //    errorMsgs += 'Enter a valid phone number<br>';
                //}
                if (terminalId.length == 0 || terminalId.length > 8) {
                    errorMsgs += 'Enter a valid terminal ID<br>';
                }
                if (role.length == 0) {
                    errorMsgs += 'Please select a role';
                }
                if (errorMsgs.length == 0) {
                    $('#successFlag').hide();
                    $("#loading").show();
                    //var lastNineDigits = phoneNo.substring(phoneNo.length - 9);
                    //var newPhoneNo = "255" + lastNineDigits;
                    //formData.set("phone", newPhoneNo);
                    // Retrieve the JSON string
                    var accountJsonString = localStorage.getItem("account");
                    // Parse the JSON string back to JS object
                    // var account = JSON.parse(accountJsonString);
                    formData.append('account', accountJsonString);
                    $.ajax({
                        url: "/addTerminal",
                        type: 'POST',
                        data: formData,
                        enctype: 'multipart/form-data',
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            localStorage.clear();
                            $('.error').html('');
                            $('#loading').hide();
                            $('#successFlag').show();
                            if (res.result == 0) {
                                $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Terminal Added Successfully</strong></div>');
                                $('#terminalsTable').DataTable().ajax.reload();
                                $('#accountDetails').hide();
                                $('#addTerminalForm')[0].reset();
                                $('#searchAccountForm')[0].reset();
                                $('#addTerminalForm').hide();
                            } else {
                                $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            $('#loading').hide();
                            $('#successFlag').show();
                            $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+thrownError+'</strong></div>');
                        }
                    });
                } else {
                    $('#successFlag').show();
                    $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+errorMsgs+'</strong></div>');
                }
            });
        });

        function unlockTerminal(id) {
            $("#loading").show();
            $.ajax({
                url: "/unlockTerminal",
                data: {id: id},
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Agent unlocked successfully!</strong></div>');
                        $('#terminalsTable').DataTable().ajax.reload(null, false);
                    } else {
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                    }
                    $("#loading").hide();
                }
            });
        }

        function terminalStatus(id, mobileNo, enabled) {
            if (enabled)
                swal({
                    title: 'Block device remarks',
                    html: `<textarea rows="3" id="remarks" name="remarks" class="swal2-input" placeholder="Enter remarks" autocomplete="off" th:required="true">`,
                    type: "question",
            //        allowOutsideClick: false,
                    confirmButtonText: 'Block',
                    confirmButtonColor: "#3ba03e"
                })
                .then((result) => {
                    if (result) {
                        const remarks = $('#remarks').val();
                        if (remarks == '') {
                            swal.showValidationMessage(`Please enter remarks why you want to block this device!`)
                        } else {
                            blockTerminal(id, mobileNo, remarks);
                        }
                    }
                });
            else
                unblockTerminal(id, mobileNo);
        }

        function unblockTerminal(id, mobileNo) {
            $("#loading").show();
            $.ajax({
                url: "/unblockTerminal",
                data: {id: id, phone: mobileNo},
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Agent unblocked successfully!</strong></div>');
                        $('#terminalsTable').DataTable().ajax.reload(null, false);
                    } else {
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                    }
                    $("#loading").hide();
                }
            });
        }

        function blockTerminal(id, mobileNo, remarks) {
            $("#loading").show();
            $.ajax({
                url: "/blockTerminal",
                data: {id: id, phone: mobileNo, remarks: remarks},
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Agent blocked successfully!</strong></div>');
                        $('#terminalsTable').DataTable().ajax.reload(null, false);
                    } else {
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                    }
                    $("#loading").hide();
                }
            });
        }

        function resetPassword(id, mobileNo) {
            $("#loading").show();
            $.ajax({
                url: "/resetPassword",
                data: {id: id, phone: mobileNo},
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Password reset successfully!</strong></div>');
                        $('#terminalsTable').DataTable().ajax.reload(null, false);
                    } else {
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                    }
                    $("#loading").hide();
                }
            });
        }

        function openTerminalRoleDialog(id) {
            var htmlData = '<div class="row"><div class="panel panel-default">';
            htmlData += '<div class="panel-heading"><h4 class="panel-title">EDIT TERMINAL ROLE</h4></div>';
            htmlData += '<div class="panel-body">';
            htmlData += '<form role="form" onsubmit="editTerminalRole(event, ' + id + ');">';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-9 text-center">';
            htmlData += '<label for="version">Terminal Roles</label>';
            htmlData += '<select class="form-control" id="terminalRole" required>';
            htmlData += '<option selected>Choose...</option>';
            htmlData += '</select>';
            htmlData += '</div></div></div>';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row">';
            htmlData += '<div class="col-md-9 text-center">';
            htmlData += '<button type="submit" class="btn btn-primary">Submit</button>';
            htmlData += '</div></div></div>';
            htmlData += '</form>';
            htmlData += '</div></div></div>';
            $(".modal-dialog").addClass("modal-lg");
            $("#myModal").modal("show");
            $("#areaValue").html(htmlData);
            $.ajax({
                url: "/api/loadTerminalRoles",
                type: 'GET',
                success: function (res) {
                    $.each(res, function(index, item) {
                        $('#terminalRole').append($('<option>', {
                            value: item.id,
                            text: item.name
                        }));
                    });
                    //$("#terminalRole option:last"). attr("selected", "selected");
                }
            });
        }

        function editTerminalRole(event, id) {
            event.preventDefault();
            $("#loading").show();
            var formData = new FormData();
            formData.set("id", id);
            var roleId = $("#terminalRole").val();
            formData.set("roleId", roleId);
            if (roleId) {
                $('#successFlag').hide();
                $.ajax({
                    url: "/api/editTerminalRole",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        $('.error').html('');
                        $('#loading').hide();
                        $("#myModal").modal("hide");
                        $('#successFlag').show();
                        if (res.success == true) {
                            $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Terminal role updated successfully!</strong></div>');
                        } else {
                            $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        $('#loading').hide();
                        $("#myModal").modal("hide");
                        $('#successFlag').show();
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+thrownError+'</strong></div>');
                    }
                });
            } else {
                $('#successFlag').show();
                $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>No role selected!</strong></div>');
            }
        }

        function openEditModal(id, username, account, firstname, middlename, lastname, phone, email, appversion, tin,
            region, district, ward, town, location, latitude, longitude) {
            var htmlData = '<div class="row"><div class="panel panel-default">';
            htmlData += '<div class="panel-heading"><h4 class="panel-title">EDIT TERMINAL</h4></div>';
            htmlData += '<div class="panel-body">';
            htmlData += '<form role="form" onsubmit="editTerminal(event, ' + id + ');">';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-3">';
            htmlData += '<label for="terminal">Terminal Number</label>';
            htmlData += '<input type="text" class="form-control" id="terminal" value="' + username + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="account">Account Number</label>';
            htmlData += '<input type="text" class="form-control" id="account" value="' + account + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="version">App Version</label>';
            htmlData += '<select class="form-control" id="version" required>';
            htmlData += '<option selected>Choose...</option>';
            htmlData += '</select>';
            htmlData += '</div></div></div>';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-3">';
            htmlData += '<label for="firstname">First Name</label>';
            htmlData += '<input type="text" class="form-control" id="firstname" value="' + firstname + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="middlename">Middle Name</label>';
            htmlData += '<input type="text" class="form-control" id="middlename" value="' + middlename + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="lastname">Last Name</label>';
            htmlData += '<input type="text" class="form-control" id="lastname" value="' + lastname + '">';
            htmlData += '</div></div></div>';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-3">';
            htmlData += '<label for="phone">Phone Number</label>';
            htmlData += '<input type="tel" class="form-control" id="phone" value="' + phone + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-4">';
            htmlData += '<label for="email">Email address</label>';
            var emailAddress = email == "null" ? "" : email;
            htmlData += '<input type="email" class="form-control" id="email" aria-describedby="emailHelp" value="' + emailAddress + '">';
            htmlData += '<small id="emailHelp" class="form-text text-muted">Please enter a valid email.</small>';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="tin">TIN</label>';
            htmlData += '<input type="text" class="form-control" id="tin" value="' + tin + '">';
            htmlData += '</div></div></div>';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-3">';
            htmlData += '<label for="region">Region</label>';
            htmlData += '<select class="form-control" id="region" required>';
            htmlData += '<option selected>Choose...</option>';
            htmlData += '</select>';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="district">District</label>';
            htmlData += '<select class="form-control" id="district" required>';
            htmlData += '<option selected>Choose...</option>';
            htmlData += '</select>';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="ward">Ward</label>';
            htmlData += '<input type="text" class="form-control" id="ward" value="' + ward + '">';
            htmlData += '</div></div></div>';
            htmlData += '<div class="form-group">';
            htmlData += '<div class="row"><div class="col-md-3">';
            htmlData += '<label for="town">Town</label>';
            htmlData += '<input type="text" class="form-control" id="town" value="' + town + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="location">Location</label>';
            htmlData += '<input type="text" class="form-control" id="location" value="' + location + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="latitude">Latitude</label>';
            htmlData += '<input type="text" class="form-control" id="latitude" value="' + latitude + '">';
            htmlData += '</div>';
            htmlData += '<div class="col-md-3">';
            htmlData += '<label for="longitude">Longitude</label>';
            htmlData += '<input type="text" class="form-control" id="longitude" value="' + longitude + '">';
            htmlData += '</div></div></div>';
            htmlData += '<div class="row">';
            htmlData += '<div class="col-md-9 text-center">';
            htmlData += '<button type="submit" class="btn btn-primary">Submit</button>';
            htmlData += '</div></div>';
            htmlData += '</form>';
            htmlData += '</div></div></div>';
            $(".modal-dialog").addClass("modal-lg");
            $("#myModal").modal("show");
            $("#areaValue").html(htmlData);
            $.ajax({
                url: "/loadAppVersions",
                type: 'GET',
                success: function (res) {
                    $.each(res, function(index, item) {
                        $('#version').append($('<option>', {
                            value: item.versionNo,
                            text: item.versionName
                        }));
                    });
                    $("#version option:last"). attr("selected", "selected");
                }
            });
            $.ajax({
                url: "/api/loadRegions",
                type: 'GET',
                success: function (res) {
                    $.each(res, function(index, item) {
                        $('#region').append($('<option>', {
                            value: item.id,
                            text: item.region
                        }));
                    });
                }
            });
            $("#region").on('change', function () {
                var region = $(this).val();
                $.ajax({
                    url: "/api/loadDistricts",
                    type: 'GET',
                    data: {region: region},
                    success: function (res) {
                        $.each(res, function(index, item) {
                            $('#district').append($('<option>', {
                                value: item.id,
                                text: item.district
                            }));
                        });
                    }
                });
            })
        }

        function editTerminal(event, id) {
            event.preventDefault();
            $("#loading").show();
            var formData = new FormData();
            formData.set("id", id);
            var phoneNo = $("#phone").val();
            var terminalId = $("#terminal").val();
            formData.set("terminal", terminalId);
            var accountNo = $("#account").val();
            formData.set("account", accountNo);
            var firstName = $("#firstname").val();
            formData.set("firstname", firstName);
            var middleName = $("#middlename").val();
            formData.set("middleName", middleName);
            var lastName = $("#lastname").val();
            formData.set("lastname", lastName);
            var email = $("#email").val();
            formData.set("email", email);
            var location = $("#location").val();
            formData.set("location", location);
            var appVersion = $("#version option:selected").val();
            formData.set("appVersion", appVersion);
            var region = $("#region option:selected").val();
            formData.set("region", region);
            var district = $("#district option:selected").val();
            formData.set("district", district);
            var tin = $("#tin").val();
            formData.set("tin", tin);
            var ward = $("#ward").val();
            formData.set("ward", ward);
            var town = $("#town").val();
            formData.set("town", town);
            var location = $("#location").val();
            formData.set("location", location);
            var latitude = $("#latitude").val();
            formData.set("latitude", latitude);
            var longitude = $("#longitude").val();
            formData.set("longitude", longitude);
            var errorMsg = "";
            if (phoneNo.length == 0) {
                errorMsg += "Enter a valid phone number<br>";
            }
            if (terminalId.length == 0 || terminalId.length > 8) {
                errorMsg += "Enter a valid terminal ID<br>";
            }
            if (errorMsg.length == 0) {
                $('#successFlag').hide();
                var lastNineDigits = phoneNo.substring(phoneNo.length - 9);
                var newPhoneNo = "255" + lastNineDigits;
                formData.set("phone", newPhoneNo);
                $.ajax({
                    url: "/editTerminal",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        $('.error').html('');
                        $('#loading').hide();
                        $('#successFlag').show();
                        if (res.result == 0) {
                            $("#successFlag").html('<div class="alert alert-success" role="alert" id="successAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>Terminal Edited Successfully!</strong></div>');
                            $('#terminalsTable').DataTable().ajax.reload();
                            $('#accountDetails').hide();
                            $('#editTerminalForm')[0].reset();
                        } else {
                            $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+res.message+'</strong></div>');
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        $('#loading').hide();
                        $('#successFlag').show();
                        $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+thrownError+'</strong></div>');
                    }
                });
            } else {
                $('#successFlag').show();
                $("#successFlag").html('<div class="alert alert-danger" role="alert" id="errorAlert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> </button><strong>'+errorMsg+'</strong></div>');
            }
        }
    </script>
</div>
