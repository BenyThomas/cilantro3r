<div layout:fragment="pageStyle" th:remove="tag">
  <style>
    #loading {
        background: url('/assets/images/ajax-loader.gif') no-repeat center center;
        position: absolute;
        top: 0;
        left: 0;
        height: 92%;
        width: 100%;
        z-index: 9999999;
    };
    #instant_dt{
        table-layout: fixed !important;
        word-wrap:break-word;
    }
  </style>
  <link th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" rel="stylesheet" type="text/css"/>
  <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
</div>
<div class="row">
  <div class="panel panel-default panel-fill" id="tabContents"><div class="panel-heading"> <h4 class="panel-title" th:text="${pageTitle}"></h4></div>
    <div class="panel-body">
      <div id="successFlag">
      </div>
      <div  id="loading" hidden=""> </div>
      <div class="row">
        <table id="instant_dt" class="display nowrap table table-striped table-bordered" style="width: 100%; font-size: 7.5px !important;">
          <thead>
          <tr>
            <th>ID</th>
            <th>PAN</th>
            <th>Account No</th>
            <th>Customer Name</th>
            <th>Originating Branch</th>
            <th>Step Name</th>
            <th>Message</th>
            <th>Update Date</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div layout:fragment="pageScript" th:remove="tag">
  <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
  <!-- init -->
  <script th:src="@{/assets/pages/jquery.datatables.init.js}"></script>
  <!-- App Js -->
  <script th:src="@{/assets/js/jquery.app.js}"></script>
  <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>

  <script>
    $(document).ready(function () {
      $("#loading").hide();
      $("#select2").select2();
      var token = $("meta[name='_csrf']").attr("content");
      var header = $("meta[name='_csrf_header']").attr("content");

      var table = $('#instant_dt').DataTable({
        dom: 'Blfrtip',
        lengthChange: true,
        scrollCollapse: true,
        scrollX: true,
        pageLength: 10,
        lengthMenu: [
          [5, 10, 25, 50, 100, 500, -1],
          [5, 10, 25, 50, 100, 500, 'Show all']
        ],
        responsive: false,
        processing: true,
        serverSide: true,
        serverMethod: 'post',
        order: [1, "desc"],
        ajax: {
          url: '/fireGetFailedInstantVisaCardAjax',
          beforeSend: function (request) {
            request.setRequestHeader(header, token);
          },
          dataSrc: function (json) {
            return json.result.reponseData || []; // extract correct array
          }
        },
        columns: [
          { data: "cardId", width: "5%" },
          { data: "pan", width: "5%" },
          { data: "accountNo", width: "5%" },
          { data: "customerName", width: "5%" },
          {
            data: "branch", width: "5%",
            render: function (data) {
              return data ? data : "-";
            }
          },
          { data: "failedStep", width: "5%" },
          { data: "failureMessage", width: "5%" },
          { data: "failedAt", width: "5%" },
          {
            data: "cardId", searchable: false, width: "5%",
            render: function (data, type, row, meta) {
              return '<div><a class="btn btn-xs btn-primary" onclick="completeCardIssuance(\'' + data + '\')"><i class="fa fa-check-circle-o" aria-hidden="true">Complete</i></a></div>';
            }
          }
        ],
        aoColumnDefs: [
          { bSortable: false, aTargets: [-1] }
        ],
        columnDefs: [
          { width: 1000, targets: 14 }
        ],
        buttons: [
          { extend: "copy", title: 'Failed Card Issuance', className: "btn-sm" },
          { extend: "csv", title: 'Failed Card Issuance', className: "btn-sm" },
          { extend: "excel", title: 'Failed Card Issuance', className: "btn-sm" },
          { extend: "pdf", title: 'Failed Card Issuance', className: "btn-sm" },
          { extend: "print", title: 'Failed Card Issuance', className: "btn-sm" }
        ]
      });

      table.on('order.dt search.dt', function () {
        table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
          cell.innerHTML = i + 1;
        });
      }).draw();
    });

    function reloadDatatable() {
      $('#instant_dt').DataTable().ajax.reload();
    }

    function completeCardIssuance(id) {
      $("#loading").show();
      var formData = new FormData();
      formData.append("cardId", id);
      $.ajax({
        url: "/fireCompleteFailInstantVisaCardAjax",
        data: formData,
        type: "POST",
        processData: false,
        contentType: false,
        success: function (response) {
          console.log(response)
          $("#loading").hide();
          var messageBox = response.status === "SUCCESS"
                  ? '<div class="alert alert-success" role="alert"><button type="button" class="close" data-dismiss="alert">×</button><strong>' + response.result + '</strong></div>'
                  : '<div class="alert alert-danger" role="alert"><button type="button" class="close" data-dismiss="alert">×</button><strong>' + response.result + '</strong></div>';

          $("#successFlag").html(messageBox);
          $('#successFlag').delay(2000).fadeIn().fadeOut();
          reloadDatatable();
        }
      });
    }
  </script>

</div>
