<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <head>
        <title>HQ-CARD MANAGEMENT</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

    </head>
    <body>
        <div layout:fragment="pageStyle" th:remove="tag">
            <link th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" rel="stylesheet" type="text/css"/>
            <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
            <link th:href="@{/assets/plugins/select2/css/select2.min.css}" rel="stylesheet" type="text/css" />

        </div>
        <div class="panel panel-default panel-fill" id="tabContentsss"><div class="panel-heading"> <h4 class="panel-title" th:text="${pageTitle}"></h4></div>
            <div class="panel-body">
                <div class="row">
                    <form role="form">
                        <div class="form-group col-md-3">
                            <select class="form-control select2" id="branchCode" selected="selected" name="branchCode">
                                <option  value="">Select Branch</option>
                                <option th:each="bran: ${branches}" th:value="${bran.code}" th:text="${bran.name}"> Branch  </option>
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <select class="form-control select2" id="statusCode" selected="selected" name="statusCode">
                                <option  value="">Select Card Status</option>
                                <option  value="AP">Cards awaiting Printing</option>
                                <option  value="CP">Cards awaiting Dispatch</option>
                                <option  value="DP">Cards Dispatched</option>
                                <option  value="DP">Cards Dispatched</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div id="successFlag">
                </div>
                <div class="row" id="loading"> 
                    <img th:src="@{/assets/images/please_wait.gif}" alt="please wait"/>
                </div>
                <div class="form-group  col-md-12">
                    <button id="sendEmailThirdParty" class="btn btn-primary pull-right col-md-3" style="    background-color: #940a0a !important;border: 1px solid #ffffff !important;" onclick="receiveCardsFromPrintingUnit()">Receive from Printing</button>
                    <button id="confirmBulkCbs" class="btn btn-primary pull-right col-md-3" style="    background-color: #0a941b !important;border: 1px solid #ffffff !important;" onclick="dispatchCardsToBranches()">Dispatch To Branch</button>
                    <!--            <button id="confirmBulkCbs" class="btn btn-primary pull-right col-md-3" style="    background-color: #0a941b !important;border: 1px solid #ffffff !important;">Acknowledge Recipient Branch</button>-->
                </div>
                <div class="row">
                    <!--<form>-->

                    <table id="cardManagement" class="table table-striped table-bordered"  style="width: 100%; font-size: 8.5px !important;">
                        <thead>
                            <tr>
                                <th>S/N</th>
                                <th>Customer RIM</th>
                                <th>Customer name</th>
                                <th>Account Number</th>
                                <th>PAN</th>
                                <th>Phone Number</th>
                                <th>Bin</th>
                                <th>Status</th>
                                <th><input type="button" class="btn btn-primary" onclick='selectAll()' value="Tick All"/> &nbsp;<input type="button" onclick='UnSelectAll()' class="btn btn-primary" value="UnTick"/></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <!--</form>-->
                </div>
            </div>
            <div layout:fragment="pageScript" th:remove="tag">
                <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
                <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
                <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
                <!--init--> 
                <script th:src="@{/assets/pages/jquery.datatables.init.js}"></script>
                <!--App Js--> 
                <script th:src="@{/assets/js/jquery.app.js}"></script>
                <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>
                <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
                <script th:src="@{/assets/scripts/ebanking.js}"></script>
                <script>
                    $(document).ready(function () {
                        $("#loading").hide();
                        $(".select2").select2();
                        $("#branchCode").on('change', function () {
                            $('#cardManagement').DataTable().ajax.reload();
                        });
                        $("#statusCode").on('change', function () {
                            $('#cardManagement').DataTable().ajax.reload();
                        });
                        var token = $("meta[name='_csrf']").attr("content");
                        var header = $("meta[name='_csrf_header']").attr("content");
                        var b = 1;
                        var i = 0;
                        var table = $('#cardManagement').DataTable({
                            dom: 'Blfrtip',
                            lengthChange: true,
                            lengthMenu: [10, 25, 50, 100, 200, 300, 500, 1000, 2000, 5000, 10000, 25000],
                            responsive: true,
                            processing: true,
                            serverSide: true,
                            serverMethod: 'post',
                            order: [0, "desc"],
                            ajax: {
                                'url': '/getHqCardManagementAjax',
                                'beforeSend': function (request) {
                                    request.setRequestHeader(header, token);
                                },
                                "data": function (d) {
                                    return $.extend({}, d, {
                                        "branchCode": $("select[name='branchCode']").val(),
                                        "statusCode": $("select[name='statusCode']").val()
                                    });
                                }
                            },
                            "columns": [
                                {"data": 'customer_rim_no'},
                                {"data": "customer_rim_no"},
                                {"data": "customer_name"},
                                {"data": 'account_no'},
                                {"data": "PAN","render": function (data, type, row, meta) {
                                        var a = row.PAN;

                                        return maskCard(a);
                                    }},
                                {"data": "phone"},
                                {"data": "bin"},
                                {"data": 'status',
                                    "render": function (data, type, row, meta) {
                                        var a = '';
                                        if (row.status === "I") {
                                            a = "INITIATED"
                                        }
                                        if (row.status === "P") {
                                            a = "PENDING"
                                        }
                                        if (row.status === "C") {
                                            a = "COMPLETED"
                                        }
                                        if (row.status === "AP") {
                                            a = "AWAITING PRINTING"
                                        }
                                        if(row.status === "RA"){
                                        a = "RETURNED FOR AMENDMENT"
                                        }
                                        return a;
                                    }},
                                {"data": 'customer_rim_no',
                                    "orderable": false,
                                    "searchable": false,
                                    "render": function (data, type, row, meta) {
                                        var a = '<input type="checkbox" id="' + row.PAN + '==' + row.account_no + '" name="cardDetails"/>';
                                        return a;
                                    }}
                            ], aoColumnDefs: [
                                {
                                    bSortable: false,
                                    aTargets: [-1]
                                }
                            ], buttons: [{
                                    extend: "copy",
                                    title: 'CARD MANAGEMENT',
                                    className: "btn-sm"
                                }, {
                                    extend: "csv",
                                    title: 'CARD MANAGEMENT',
                                    className: "btn-sm"
                                }, {
                                    extend: "excel",
                                    title: 'CARD MANAGEMENT',
                                    className: "btn-sm"
                                }, {
                                    extend: "pdf",
                                    title: 'CARD MANAGEMENT',
                                    className: "btn-sm"
                                }, {
                                    extend: "print",
                                    title: 'CARD MANAGEMENT',
                                    className: "btn-sm"
                                }],
                            "preDrawCallback": function (settings) {
                                if ($("select[name='mno']").val() == '') {
                                    return false;
                                }
                            }
                        });
                        table.on('order.dt search.dt', function () {
                            table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                                cell.innerHTML = i + 1;
                            });
                        }).draw();
                    });


                    function reloadDatatable() {
                        $('#cardManagement').DataTable().ajax.reload();
                    }

                    function maskCard(cardNumber) {
                        // Extract and format the parts of the card number
                        const firstSeven = cardNumber.slice(0, 7); // First 7 digits
                        const lastFour = cardNumber.slice(-4);    // Last 4 digits
                        return `${firstSeven} ** **** ${lastFour}`;
                    }
                </script>
            </div>
        </div>
    </body>
</html>