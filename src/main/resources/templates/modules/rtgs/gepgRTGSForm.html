<div layout:fragment="pageStyle" th:remove="tag" xmlns:th="http://www.w3.org/1999/xhtml">
    <style>
        #loading {
            background: url('/assets/images/ajax-loader.gif') no-repeat center center;
            position: absolute;
            top: 0;
            left: 0;
            height: 92%;
            width: 100%;
            z-index: 9999999;
        }
        .btn{
            border-radius: 0px !important;
        }
        .btn-dark {
            background-color: #107f13!important;
            border: 1px solid #ffffff!important;
        }
    </style>
    <link th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/select2/css/select2.min.css}" rel="stylesheet" type="text/css" />
</div>
<div  id="loading"> </div>
<div class="panel panel-default panel-fill" id="tabContentsss"> <div class="panel-heading"> <h4 class="panel-title" th:text="${pageTitle}"></h4></div>
    <div class="panel-body">
        <div class="row" id="rtgsPayments">
            <div class="col-md-12" id="successFlag"></div>
            <div class="col-md-12 pull-right" id="MT_TYPES"></div>
            <div class="col-md-12" id="rtgsTransferFormDiv">
                <div id="errorMessage"></div>
                <div class="row">
                    <div class="col-sm-6">
                        <input type="text" name="controlNo"  id="controlNo" autocomplete="off"  class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Control Number">
                    </div>
                    <div class="col-sm-6">
                        <button type="button" class="btn btn-primary" onclick="validateGePGControlNo()">Validate</button>   
                    </div>
                </div>
                <div class="row" hidden="" id="tranferFormInformation">

                    <form class="form-horizontal" role="form" id="rtgsTransferForm">
                        <input hidden="" name="accountCurrency" id="accountCurrency">
                        <input  name="transactionType" id="transactionType" value="TISS" hidden="" readonly="">

                        <table  class="table table-striped table-bordered"  style="width: 100%; font-size: 8.5px !important;">
                            <tbody>
                                <tr>
                                    <td>Sender Account</td>
                                    <td>
                                        <input type="text" name="senderAccount"  class="form-control form-control-sm" autocomplete="off" style="font-size: 10px !important;" placeholder="Sender Account No." id="senderAccount"><button type="button" class="btn btn-primary btn-submit" style="font-size: 9px !important;" onclick="getAccountDetails()">Query Details</button>
                                    </td>
                                    <td>Sender Name <h5 id="branchName" style="font-size: 9px;"></h5> <h5 id="ledgerName" style="font-size: 9px;"></h5></td>
                                    <td><input type="text" name="senderName"  id="actNM" autocomplete="off"  class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Sender Name">
                                    </td>
                                </tr>
                                <tr>
                                    <td>Amount <h5 id="quotedAmount" style="color: red;    font-size: 9px;"></h5></td>
                                    <td><input type="text" name="amount" id="amount" class="form-control form-control-sm" autocomplete="off" style="font-size: 10px !important;" placeholder="Amount"></td>
                                    <td>Sending Currency</td>
                                    <td>
                                        <input type="text" id="currency" name="currency" class="form-control form-control-sm" autocomplete="off" style="font-size: 10px !important;" placeholder="currency" readonly="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>Beneficiary Bank</td>
<!--                                    <td><input  type="text" id="beneficiaryBank" name="beneficiaryBIC" class="form-control form-control-sm" autocomplete="off" style="font-size: 10px !important;" placeholder="Beneficiary Bank" readonly="">-->
                                    <td><select  id="beneficiaryBank" name="beneficiaryBIC" class="form-control form-control-sm select2" autocomplete="off">
                                        <option value="">SELECT BEN BANK...</option>
                                    </select>
                                    </td>
                                    <td>Beneficiary Name</td>
                                    <td><input readonly="" type="text" id="beneficiaryName" name="beneficiaryName" class="form-control form-control-sm" autocomplete="off" style="font-size: 10px !important;" placeholder="Beneficiary Name"></td>
                                </tr>
                                <tr>
                                    <td>Beneficiary Account</td>
                                    <td><input type="text" id="beneficiaryAccount" name="beneficiaryAccount" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Beneficiary Account" readonly=""></td>


                                    <td>Sender Address</td>
                                    <td><input  type="text" id="customerAddress" name="senderAddress" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Sender Address"></td>
                                </tr>
                                <tr>
                                    <td>Beneficiary Contact</td>
                                    <td><input type="text" id="beneficiaryContact" name="beneficiaryContact" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Beneficiary Contact"></td>
                                    <td>Sender Phone</td>
                                    <td><input type="text"  id="senderPhone" name="senderPhone" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Sender Phone"></td>
                                </tr>
                                <tr>
                                    <td>Payment Purpose</td>
                                    <td>
                                        <input type="text" name="description" id="description" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Purpose" readonly="">
                                        <textarea name="paymentPurpose" id="paymentPurpose" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="payment purpose"></textarea>
                                    </td>
                                    <td>Supporting Document</td>
                                    <td><div id="supportingDocument"><input type="file" name="supportingDoc" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Supporting Document"> <button class="btn btn-primary" id="addField"><span style="font-size:16px; font-weight:bold;">+ </span></button></div>
                                    </td>
                                </tr>
                                <tr hidden="" id="systemRate">
                                    <td>Currency conversion</td>
                                    <td><input type="text" id="currencyConversion" readonly="" name="currencyConversion" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Currency Conversion"></td>
                                    <td>Rubikon Rate</td>
                                    <td><input type="text" id="rubikonRate" readonly="" name="rubikonRate" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Rubikon Rate"></td>
                                </tr>
                                <tr hidden="" id="requestingRate">
                                    <td>Requesting Rate</td>
                                    <td><input type="text"  name="requestingRate" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Enter Requesting Rate"></td>
                                    <td>FX Type</td>
                                    <td><input type="text" id="fxType" readonly="" name="fxType" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Fx Type"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="row">
                            <button type="button" class="btn btn-primary initiate-gepg-rtgs-payments">Submit For Approval</button>   
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!--<div class="form-group col-md-9">-->
<div class="row"></div>
<div class="row">
</div>
<div layout:fragment="pageScript" th:remove="tag">
    <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
    <!--init--> 
    <script th:src="@{/assets/pages/jquer   y.datatables.init.js}"></script>
    <!--App Js--> 
    <script th:src="@{/assets/js/jquery.app.js}"></script>
    <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>
    <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
    <script th:src="@{/assets/scripts/teller.js}"></script>
    <script>
        $(document).ready(function () {
            $('.select2').select2({width:'100%'});
            $("#loading").hide();
            //            rtgsTransferForm


            //get account number for selected bank
            $("#beneficiaryBank").change(function(e){
                var selectedAcc = $(this).find("option:selected").attr('data-accNum');
                $("#beneficiaryAccount").val(selectedAcc);
            });
            //add the number of files to be attached
            var max_fields = 4;
            var wrapper = $("#supportingDocument");
            var add_button = $("#addField");

            var x = 1;
            $(add_button).click(function (e) {
                e.preventDefault();
                if (x < max_fields) {
                    x++;
                    $(wrapper).append('<input type="file" name="supportingDoc" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Supporting Document">'); //add input box
                } else {
                    alert('You Reached the limits');
                }
            });

            $(wrapper).on("click", ".delete", function (e) {
                e.preventDefault();
                $(this).parent('div').remove();
                x--;
            });
            //ON SELECTING DESTINATION BANK CHECK IF ITS INTERNATIONAL AND ADD AN INPUT FIELD FOR INTERMEDIARY BANK
            $('#intermediary').html("");
            $("#beneficiaryBank").on('change', function () {
                var benBic = $("select[name='beneficiaryBIC']").val();
                var identifier = benBic.split('==');
                if (identifier[1] === 'INTERNATIONAL') {
                    /*
                     * ADD AN INPUT FOR INTERMEDIARY SWIFT CODE
                     */
                    $('#intermediary').append('<input type="text" id="intermediaryBank" name="intermediaryBank" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');

                }
            });
        });
        function getAccountDetails() {
            console.log("sender account pressed!!!");
            $("#loading").show();
            var accountNo = $("input[name='senderAccount']").val();
            $.ajax({
                url: "/querySenderDetails",
                type: 'GET',
                data: {accountNo: accountNo, code: "searchAccount"},
                dataType: "json",
                success: function (res) {
                    $("#loading").hide();
                    $("#actNM").val(res[0].CUST_NM);
                    $("#branchName").text('BRANCH NAME: ' + res[0].BRANCHNAME);
                    $("#ledgerName").text('LEDGER NAME: ' + res[0].ACCT_DESC);
                    $("#availableBalance").text('Available Blance: ' + addCommas(res[0].CLEARED_BAL));
                    $("#accountCurrency").val(res[0].CURRENCY);
                    $("#customerAddress").val(res[0].ADDR_LINE_1 + ',' + res[0].ADDR_LINE_2 + ' , ' + res[0].ADDR_LINE_3 + ' , ' + res[0].ADDR_LINE_4);
                    console.log(res)
                },
                error: function (res) {
                    $("#loading").hide();
                    $('#senderAccount').after('<h4 class="error" style="color:red     font-size: 8px !important;"> Error: Please Try Again. Please contact IT Helpdesk / Database Administrator: RUBIKON NOT FOUND</h4>');
                    console.log(res);
                }
            })
        }

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }
        function validateGePGControlNo() {
            var controlNo = $("input[name='controlNo']").val();
            $.ajax({
                url: "/queryControlNumberDetails",
                type: 'GET',
                data: {controlNo: controlNo},
                dataType: "json",
                success: function (res) {
                    const flattened = { ...res, ...res.TipsLookupResp };
                    delete flattened.TipsLookupResp;
                    if (res.p2g) {
                        res = res.TipsLookupResponse;
                        if (res.responseCode != '0') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>' + res.transactionReference + ': ' + res.message + '</strong></div>').show();
                        } else if ((res.billStsCode == '7336') || (res.billStsCode == '7101')) {
                            console.log('BENEFICIARY NAME:' + res.beneficiaryName);
                            $("#tranferFormInformation").show();
                            $("#beneficiaryName").val(res.beneficiaryName);
                            $("#currency").val("TZS");
                            $("#beneficiaryBank").append('<option data-accNum='+controlNo+' value='+res.beneficiaryInstitutionCode+'==LOCAL>'+res.bankName+'</option>');
                            $("#amount").val(res.billAmt);
                            $("#beneficiaryAccount").val(controlNo);
                            $("#beneficiaryBank").val(res.bankBic);
                            $("#description").val('/ROC/' + controlNo);
                            $("#senderPhone").val(res.payerCellNum);
                            $("#beneficiaryContact").val("0");
                            var payOption = "-1";
                            if (res.payOpt == '1') {
                                payOption = "payment option - shall be paid in one instalment with the amount paid equal or greater than the billed amount;";
                                $("#amount").val(res.billAmt).prop("readonly", true);
                            }
                            if (res.payOpt == '2') {
                                payOption = "payment option - may be paid in single or multiple instalments, with the last instalment greater or equal to the remaining billed amount";
                                $("#amount").val(res.billAmt);
                            }
                            if (res.payOpt == '3') {
                                payOption = "payment option - shall be paid in one instalment with the amount paid being equal to the billed amount";
                                $("#amount").val(res.billAmt).prop("readonly", true);
                            }
                            if (res.payOpt == '4') {
                                payOption = "payment option – shall be paid with any amount greater than zero (0)";
                            }
                            if (res.payOpt == '5') {
                                payOption = "payment option - may be paid in single or multiple instalments, with the last instalment equal to the remaining billed amount";
                            }
                            $("#errorMessage").html('<div class="alert alert-success" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>' + 'CONTROL NO:' + res.custCtrNum + ' AMOUNT ' + addCommas(res.billAmt) + " DETAILS: " + payOption + '</strong></div>').show();
                        } else if (res.billStsCode == '7204') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>' + res.billStsDesc + ' ERROR CODE:7204</strong></div>').show();
                        } else if (res.billStsCode == '7101') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>Process this payment in ITAX under GePG payments ERROR CODE: 7101</strong></div>').show();
                        } else if (res.billStsCode == '7340') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>Process this payment in ITAX under GePG payments ERROR CODE: 7340</strong></div>').show();
                        } else {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"aria-label="Close"> </button><strong>' + res.billStsDesc + ' ERROR CODE:' + res.billStsCode + '</strong></div>').show();
                        }
                    } else {
                        console.log('BENEFICIARY NAME:' + res.Gepg.gepgBillQryResp.BillHdr.SpName);
                        if ((res.Gepg.gepgBillQryResp.BillHdr.BillStsCode == '7336') || (res.Gepg.gepgBillQryResp.BillHdr.BillStsCode == '7101')) {
                            $("#tranferFormInformation").show();
                            $("#beneficiaryName").val(res.Gepg.gepgBillQryResp.BillHdr.SpName);
                            $("#currency").val(res.Gepg.gepgBillQryResp.BillDtl.Ccy);
                            var json = res.Gepg.gepgBillQryResp.TxfrAcc.AccDtl;

                            if (json != null) {
                                if ($.isArray(json)) {
                                    for(let i = 0; i < json.length; i++) {
                                        let obj = json[i];
                                        $("#beneficiaryBank").append('<option data-accNum= '+obj.CollAccNum+' value='+obj.BankBic+'==LOCAL>'+obj.BankName+'</option>');
                                    }
                                } else {
                                     $("#beneficiaryBank").append('<option data-accNum= '+json.CollAccNum+' value='+json.BankBic+'==LOCAL>'+json.BankName+'</option>');
                                }
                            } else {
                                $("#beneficiaryBank").append('<option data-accNum= '+res.beneficiaryAccount+' value='+ res.beneficiaryBic+'>'+res.beneficiaryName+'</option>');
                            }


                            var payOption = "-1";
                            if (res.Gepg.gepgBillQryResp.BillDtl.PayOpt == '1') {
                                payOption = "payment option - shall be paid in one instalment with the amount paid equal or greater than the billed amount;";
                                $("#amount").val(res.Gepg.gepgBillQryResp.BillDtl.BillAmt).prop("readonly", true);
                            }
                            if (res.Gepg.gepgBillQryResp.BillDtl.PayOpt == '2') {
                                payOption = "payment option - may be paid in single or multiple instalments, with the last instalment greater or equal to the remaining billed amount";
                                $("#amount").val(res.Gepg.gepgBillQryResp.BillDtl.BillAmt);
                            }
                            if (res.Gepg.gepgBillQryResp.BillDtl.PayOpt == '3') {
                                payOption = "payment option - shall be paid in one instalment with the amount paid being equal to the billed amount";
                                $("#amount").val(res.Gepg.gepgBillQryResp.BillDtl.BillAmt).prop("readonly", true);
                            }
                            if (res.Gepg.gepgBillQryResp.BillDtl.PayOpt == '4') {
                                payOption = "payment option – shall be paid with any amount greater than zero (0)";
                            }
                            if (res.Gepg.gepgBillQryResp.BillDtl.PayOpt == '5') {
                                payOption = "payment option - may be paid in single or multiple instalments, with the last instalment equal to the remaining billed amount";
                            }
                            $("#amount").val(res.Gepg.gepgBillQryResp.BillDtl.BillAmt);
                            $("#beneficiaryAccount").val(res.beneficiaryAccount);
                            $("#beneficiaryBank").val(res.beneficiaryBic);
                            $("#description").val('/ROC/' + res.Gepg.gepgBillQryResp.BillDtl.BillCtrNum);
                            $("#senderPhone").val(res.Gepg.gepgBillQryResp.BillDtl.PyrCellNum);
                            $("#beneficiaryContact").val("0");
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>' + 'CONTROL NO:' + res.Gepg.gepgBillQryResp.BillDtl.BillCtrNum + ' AMOUNT ' + addCommas(res.Gepg.gepgBillQryResp.BillDtl.BillAmt) + " DETAILS: " + payOption + '</strong></div>').show();
                        } else if (res.Gepg.gepgBillQryResp.BillHdr.BillStsCode == '7204') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>' + res.Gepg.gepgBillQryResp.BillHdr.BillStsDesc + ' ERROR CODE:7204</strong></div>').show();
                        } else if (res.Gepg.gepgBillQryResp.BillHdr.BillStsCode == '7101') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>Process this payment in ITAX under GePG payments ERROR CODE: 7101</strong></div>').show();
                        } else if (res.Gepg.gepgBillQryResp.BillHdr.BillStsCode == '7340') {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>Process this payment in ITAX under GePG payments ERROR CODE: 7340</strong></div>').show();
                        } else {
                            $("#errorMessage").html('<div class="alert alert-danger" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>' + res.Gepg.gepgBillQryResp.BillHdr.BillStsDesc + ' ERROR CODE:' + res.Gepg.gepgBillQryResp.BillHdr.BillStsCode + '</strong></div>').show();
                        }
                    }
                    console.log(res)
                },
                error: function (res) {
                    $("#loading").hide();
                    $('#senderAccount').after('<h4 class="error" style="color:red     font-size: 8px !important;"> Error: Please Try Again. Please contact IT Helpdesk / Database Administrator: RUBIKON NOT FOUND</h4>');
                    console.log(res);
                }
            })
        }
    </script>
</div>
