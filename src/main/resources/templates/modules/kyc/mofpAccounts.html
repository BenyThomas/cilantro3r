<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/main_layout}">
<head>
  <title>MoFP Accounts</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div layout:fragment="pageStyle" th:remove="tag">
    <style>
        #loading {
            background: url('/assets/images/ajax-loader.gif') no-repeat center center;
            position: absolute;
            top: 0;
            left: 0;
            height: 92%;
            width: 100%;
            z-index: 9999999;
        }
        .btn{
            border-radius: 0px !important;
        }
        .btn-dark {
            background-color: #000000!important;
            border: 1px solid #ffffff!important;
        }
        .btn:hover {
            color: #ffffff !important;
            text-decoration: none;
        }
        .btn-dark.active, .btn-dark.focus, .btn-dark:active, .btn-dark:focus, .btn-dark:hover, .open>.dropdown-toggle.btn-dark {
            background-color: #3db9dc!important;
            border: 1px solid #3db9dc!important;
        }
        .button.selected{
            background-color: #3db9dc!important;
            border: 1px solid #3db9dc!important;
        }
        #transactionFile {
            width: unset;
            display: inline-block;
        }
        .previous {
            text-decoration: none;
            display: inline-block;
            padding: 8px 16px;
            margin: 10px 0;
        }
        table.dataTable td.dt-control:before {
            height: 1em;
            width: 1em;
            margin-top: -9px;
            display: inline-block;
            color: white;
            border: 0.15em solid white;
            border-radius: 1em;
            box-shadow: 0 0 0.2em #444;
            box-sizing: content-box;
            text-align: center;
            text-indent: 0 !important;
            font-family: "Courier New",Courier,monospace;
            line-height: 1em;
            content: "+";
            background-color: #31b131;
        }
    </style>
    <link th:href="@{/assets/plugins/bootstrap-tagsinput/css/bootstrap-tagsinput.css}" rel="stylesheet"/>
    <link th:href="@{/assets/plugins/switchery/switchery.min.css}" rel="stylesheet"/>
    <link th:href="@{/assets/plugins/select2/css/select2.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/timepicker/bootstrap-timepicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/clockpicker/css/bootstrap-clockpicker.min.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/bootstrap-daterangepicker/daterangepicker.css}" rel="stylesheet">
    <link th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/datatables/select.dataTables.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/assets/plugins/sweet-alert2/sweetalert2.min.css}" rel="stylesheet" type="text/css"/>
</div>
<div class="container no-print" layout:fragment="contents">
  <div class="container" style="padding-left: 0;">
    <h2 style="margin-top: 12px;margin-bottom: 7px;background-color: #2b6331;padding: 10px;color: white;" th:text="${pageTitle}"></h2>
  </div>
  <div class="container">
    <div id="successFlag"></div>
    <div id="loading" hidden=""></div>
    <div class="row">
      <ul class="nav nav-tabs" style="font-size: 10px !important;">
        <li class="nav-item active">
          <a style="font-size: 10px !important;" href="#workflowTabContent" data-toggle="tab" data-target="#workflowTabContent" aria-expanded="true" class="nav-link">
            Workflow
          </a>
        </li>
        <li class="nav-item">
          <a style="font-size: 10px !important;" href="#manageAccountsTabContent" data-toggle="tab" data-target="#manageAccountsTabContent" aria-expanded="true" class="nav-link">
            Manage Accounts
          </a>
        </li>
        <li class="nav-item">
          <a style="font-size: 10px !important;" href="#reportTabContent" data-toggle="tab" data-target="#reportTabContent" aria-expanded="false" class="nav-link">
            Reports
          </a>
        </li>
      </ul>
      <div class="tab-content" id="workflowTabContent" hidden>
        <div class="row">
          <form role="form">
            <div class="form-group col-md-2">
              <select class="form-control col-sm-12 select2 select2-hidden-accessible"
                      id="status" name="status" style="font-size: 10px !important;" tabindex="-1"
                      aria-hidden="true">
                <option th:value="${initialStatus}">Choose Status</option>
                <option th:each="category: ${categories}"
                        th:value="${category.name}"
                        th:text="${category.value}">
                </option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="fromDate"
                       class="form-control form-control-inline input-medium default-date-picker"
                       id="datepicker-autoclose" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="From: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="toDate"
                       class="form-control form-control-inline input-medium default-date-picker"
                       id="datepicker-autoclose2" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="To: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-1">
              <div class="form-group col-md-3 text-right m-b-0" style="margin: 2%;">
                <button type="button" class="btn btn-primary" onclick="reloadWorkflowDatatable()">
                  Search
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="row">
          <table id="accountsWorkflow" class="display nowrap table table-striped table-bordered"
                 style="width: 100%;font-size: 9.5px !important;">
            <thead>
            <tr>
              <th>S/N</th>
              <th>Message ID</th>
              <th>Payment Type</th>
              <th>Message Type</th>
              <th>Status</th>
              <th>Branch</th>
              <th>BIC</th>
              <th>Authority Ref</th>
              <th>BOT Ref</th>
              <th>Create Date</th>
              <th>Expire Date</th>
              <th>No of Rec</th>
              <th>Attachments</th>
              <th>Action</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="tab-content" id="manageAccountsTabContent" hidden>
        <div class="row">
          <form role="form">
            <div class="form-group col-md-2">
              <select class="form-control col-sm-12 select2 select2-hidden-accessible" id="branch" name="branch"
                      style="font-size: 10px !important;" tabindex="-1" aria-hidden="true">
                <option value="">Select Branch</option>
                <option th:each="branch: ${branches}" th:value="${branch.code}" th:text="${branch.name}"></option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="accountFromDate"
                       class="form-control form-control-inline input-medium default-date-picker"
                       id="accounts-datepicker-autoclose" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="From: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="accountToDate"
                       class="form-control form-control-inline input-medium default-date-picker"
                       id="accounts-datepicker-autoclose2" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="To: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-1">
              <div class="form-group col-md-3 text-right m-b-0" style="margin: 2%;">
                <button type="button" class="btn btn-primary" onclick="reloadAccountsDatatable()">
                  Search
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="row">
          <table id="govInstAcctTable" class="display nowrap table table-striped table-bordered"
                 style="width: 100%;font-size: 9.5px !important;">
            <thead>
            <tr>
              <th>S/N</th>
              <th>End To End ID</th>
              <th>Account No</th>
              <th>Account Title</th>
              <th>Currency</th>
              <th>Category</th>
              <th>Account Type</th>
              <th>Branch</th>
              <th>Operator</th>
              <th>Operator Category</th>
              <th>Purpose</th>
              <th>Owner</th>
              <th>Status</th>
              <th>Status Description</th>
              <th>Trans BIC</th>
              <th>Trans Account no</th>
              <th>Trans Account name</th>
              <th>Trans Currency</th>
              <th>Region</th>
              <th>District</th>
              <th>Phone No</th>
              <th>Email</th>
              <th>Postal Address</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="tab-content" id="reportTabContent" hidden>
        <div class="row">
          <form role="form">
            <div class="form-group col-md-2">
              <select class="form-control col-sm-12 select2 select2-hidden-accessible"
                      id="reportStatus" name="reportStatus" style="font-size: 10px !important;" tabindex="-1"
                      aria-hidden="true">
                <option value="">Choose Status</option>
                <option value="Accepted">Accepted</option>
                <option value="Rejected">Rejected</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Closed">Closed</option>
                <option value="Updated">Updated</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="reportFromDate"
                       class="form-control form-control-inline input-txndatemedium default-date-picker"
                       id="report-datepicker-autoclose" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="From: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input name="reportToDate"
                       class="form-control form-control-inline input-txndatemedium default-date-picker"
                       id="report-datepicker-autoclose2" data-date-format="yyyy-mm-dd" type="text"
                       placeholder="To: yyyy-mm-dd" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-timer"></i></span>
              </div>
            </div>
            <div class="form-group col-md-1">
              <div class="form-group col-md-3 text-right m-b-0" style="margin: 2%;">
                <button type="button" class="btn btn-primary" onclick="reloadReportDatatable()">
                  Search
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="row">
          <table id="accountsReport" class="display nowrap table table-striped table-bordered" style="width: 100%; font-size: 11px !important;">
            <thead>
            <tr>
              <th>S/N</th>
              <th>Message ID</th>
              <th>Payment Type</th>
              <th>Message Type</th>
              <th>Status</th>
              <th>Branch</th>
              <th>BIC</th>
              <th>Authority Ref</th>
              <th>BOT Ref</th>
              <th>Create Date</th>
              <th>Expire Date</th>
              <th>No of Rec</th>
              <th>Action</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <hr/>
</div>
<div layout:fragment="pageScript" th:remove="tag">
  <script th:src="@{/assets/plugins/bootstrap-tagsinput/js/bootstrap-tagsinput.min.js}"></script>
  <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
  <script th:src="@{/assets/plugins/bootstrap-filestyle/js/bootstrap-filestyle.min.js}"
          type="text/javascript"></script>
  <script th:src="@{/assets/plugins/switchery/switchery.min.js}"></script>
  <script th:src="@{/assets/plugins/parsleyjs/parsley.min.js}" type="text/javascript"></script>
  <script th:src="@{/assets/plugins/moment/moment.js}"></script>
  <script th:src="@{/assets/plugins/timepicker/bootstrap-timepicker.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
  <script th:src="@{/assets/plugins/clockpicker/js/bootstrap-clockpicker.min.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-daterangepicker/daterangepicker.js}"></script>
  <!-- Datatable -->
  <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
  <script th:src="@{/assets/plugins/datatables/dataTables.select.min.js}"></script>
  <!-- init -->
  <script th:src="@{/assets/pages/jquery.datatables.init.js}"></script>
  <!-- App Js -->
  <script th:src="@{/assets/js/jquery.app.js}"></script>
  <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>
  <script th:src="@{/assets/plugins/sweet-alert2/sweetalert2.min.js}"></script>
  <script th:src="@{/assets/scripts/kyc.js}"></script>
  <script type="text/javascript" th:inline="javascript">
        let userRoles = /*[[${roleId}]]*/;
        let initialStatus = /*[[${initialStatus}]]*/;
        $(document).ready(function () {
            $('#datepicker-autoclose').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $('#datepicker-autoclose2').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $('#accounts-datepicker-autoclose').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $('#accounts-datepicker-autoclose2').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $('#report-datepicker-autoclose').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $('#report-datepicker-autoclose2').datepicker({
                dateFormat: 'dd-mm-yy',
                autoclose: true,
                todayHighlight: true
            });
            $("#workflowTabContent").show();
            $("#manageAccountsTabContent").hide();
            $("#reportTabContent").hide();
            $("#loading").hide();
            $(".select2").select2({width: '100%'});
            $("#status").on('change', function () {
                reloadWorkflowDatatable();
            });
            $("#reportStatus").on('change', function () {
                reloadReportDatatable();
            });
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var table = $('#accountsWorkflow').DataTable({
                dom: 'Blfrtip',
                lengthChange: true,
                scrollCollapse: true,
                scrollY: "700px",
                scrollX: true,
                pageLength: 10,
                lengthMenu: [
                    [5, 10, 25, 50, 100, 500, -1],
                    [5, 10, 25, 50, 100, 500, 'Show all']
                ],
                responsive: false,
                processing: true,
                serverSide: true,
                serverMethod: 'post',
                order: [1, "asc"],
                ajax: {
                    'url': '/getPendingAccountWorkflowAjax',
                    'beforeSend': function (request) {
                        request.setRequestHeader(header, token);
                    },
                    "data": function (d) {
                        var status = $("select[name='status']").val();
                        return $.extend({}, d, {
                            "fromDate": $("input[name='fromDate']").val(),
                            "toDate": $("input[name='toDate']").val(),
                            "status": status
                        });
                    }
                },
                "columns": [
                    {"data": null},
                    {"data": "msg_id"},
                    {"data": "payment_type"},
                    {"data": "message_type"},
                    {"data": "status"},
                    {"data": "branch"},
                    {"data": "bic"},
                    {"data": "authority_ref"},
                    {"data": "bot_ref"},
                    {"data": "create_dt"},
                    {"data": "expires_dt"},
                    {"data": "nb_of_rec"},
                    {
                        "data": null,
                        "orderable": false,
                        "className": 'dt-control',
                        "defaultContent": ''
                    },
                    {
                        "data": "msg_id",
                        "render": function (data, type, row, meta) {
                            var a = '<button type="button" class="btn btn-primary" onclick="previewAccounts(\'';
                            a += row.id + '\',\'' + row.msg_id + '\',\'' + row.nb_of_rec + '\',\'' + userRoles;
                            a += '\',\'' + row.message_type + '\')">View Details</button>';
                            //a += '&nbsp;<button type="button" class="btn btn-primary" onclick="viewAttachments(\'';
                            //a += row.id + '\')">View Attachments</button>';
                            if ((userRoles.includes('21') || userRoles.includes('48') || workflowIds.includes('16')) && row.status == 'Pending' &&
                            row.message_type == 'AccountOpening' && row.ucc == row.nb_of_rec) {
                              a += '&nbsp;<button type="button" class="btn btn-success" onclick="acceptRequest(\'';
                              a += row.id + '\')">Accept</button>';
                            } else if ((userRoles.includes('21') || userRoles.includes('24') || workflowIds.includes('17')) && row.status == 'Received') {
                              a += '&nbsp;<button type="button" class="btn btn-primary" onclick="sendRequest(\'' + row.id + '\')">Send to Branch</button>';
                            }
                            if (row.status != 'Rejected') {
                              a += '&nbsp;<button type="button" class="btn btn-danger" onclick="rejectRequest(\'' + row.id + '\')">Reject</button>';
                            }
                            return a;
                        }
                    }
                ], aoColumnDefs: [
                    {
                        bSortable: false,
                        aTargets: [-1],
                    }
                ],
                buttons: [{
                        extend: "copy",
                        title: 'MoFP WORKFLOWS',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "csv",
                        title: 'MoFP WORKFLOWS',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "excel",
                        title: 'MoFP WORKFLOWS',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "pdf",
                        title: 'MoFP WORKFLOWS',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "print",
                        title: 'MoFP WORKFLOWS',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }
                ],
                preDrawCallback: function (settings) {
                    if ($("select[name='status']").val() == '') {
                        return false;
                    }
                },
                drawCallback: function(settings) {
                    // Reset margin to 0 after datatable render
                    var ele = document.querySelector('.dataTables_scrollBody');
                    if (ele) {
                        ele = ele.querySelector('.dataTable');
                        if (ele) {
                            ele.style.margin = 0;
                        }
                    }
                },
            });
            // Add event listener for opening and closing details
            $('#accountsWorkflow tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
            /* Formatting function for row details - modify as you need */
            function format(d) {
                // `d` is the original data object for the row
                var attachmentArr = d.attachments.split(',');
                var b = '';
                let i = 0;
                do {
                    console.log(attachmentArr[i]);
                    b += '<a href="/api/downloadStatusDoc?reference=' + attachmentArr[i] + '">STATUS DOCUMENT</a><br/>';
                    i++;
                } while (i < attachmentArr.length);
                return b;
            }
            table.on('order.dt search.dt', function () {
                table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();


            // Accounts Datatable
            var acctTable = $('#govInstAcctTable').DataTable({
                dom: 'Blfrtip',
                lengthChange: true,
                scrollCollapse: true,
                scrollY: "700px",
                scrollX: true,
                pageLength: 10,
                lengthMenu: [
                    [5, 10, 25, 50, 100, 500, -1],
                    [5, 10, 25, 50, 100, 500, 'Show all']
                ],
                responsive: false,
                processing: true,
                serverSide: true,
                serverMethod: 'post',
                order: [1, "asc"],
                ajax: {
                    'url': '/getMoFPAccountsAjax',
                    'beforeSend': function (request) {
                        request.setRequestHeader(header, token);
                    },
                    "data": function (d) {
                        var branch = $("select[name='branch']").val();
                        return $.extend({}, d, {
                            "fromDate": $("input[name='accountFromDate']").val(),
                            "toDate": $("input[name='accountToDate']").val(),
                            "branch": branch
                        });
                    }
                },
                "columns": [
                    {"data": null},
                    {"data": "endtoEndId"},
                    {"data": "account_no"},
                    {"data": "account_title"},
                    {"data": "ccy"},
                    {"data": "category"},
                    {"data": "acct_type"},
                    {"data": "branch"},
                    {"data": "operator"},
                    {"data": "operatorCat"},
                    {"data": "purpose"},
                    {"data": "owner"},
                    {"data": "status"},
                    {"data": "status_desc"},
                    {"data": "transBic"},
                    {"data": "transAcctNum"},
                    {"data": "transAcctName"},
                    {"data": "transCcy"},
                    {"data": "regionCode"},
                    {"data": "district"},
                    {"data": "phoneNum"},
                    {"data": "email"},
                    {"data": "postalAddr"}
                ], aoColumnDefs: [
                    {
                        bSortable: false,
                        aTargets: [-1],
                    }
                ],
                buttons: [
                    {
                        extend: "copy",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "csv",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "excel",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "pdf",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "print",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }
                ],
                drawCallback: function(settings) {
                    // Reset margin to 0 after datatable render
                    var ele = document.querySelector('.dataTables_scrollBody');
                    if (ele) {
                        ele = ele.querySelector('.dataTable');
                        if (ele) {
                            ele.style.margin = 0;
                        }
                    }
                },
            });
            acctTable.on('order.dt search.dt', function () {
                acctTable.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();

            // Report Datatable
            var reportTable = $('#accountsReport').DataTable({
                dom: 'Blfrtip',
                lengthChange: true,
                scrollCollapse: true,
                scrollY: "700px",
                scrollX: true,
                pageLength: 10,
                lengthMenu: [
                    [5, 10, 25, 50, 100, 500, -1],
                    [5, 10, 25, 50, 100, 500, 'Show all']
                ],
                responsive: false,
                processing: true,
                serverSide: true,
                serverMethod: 'post',
                order: [1, "desc"],
                ajax: {
                    'url': '/getPendingAccountWorkflowAjax',
                    'beforeSend': function (request) {
                        request.setRequestHeader(header, token);
                    },
                    "data": function (d) {
                        var status = $("select[name='reportStatus']").val();
                        return $.extend({}, d, {
                            "fromDate": $("input[name='reportFromDate']").val(),
                            "toDate": $("input[name='reportToDate']").val(),
                            "status": status,
                            "report": true
                        });
                    }
                },
                "columns": [
                    {"data": null},
                    {"data": "msg_id"},
                    {"data": "payment_type"},
                    {"data": "message_type"},
                    {"data": "status"},
                    {"data": "branch"},
                    {"data": "bic"},
                    {"data": "authority_ref"},
                    {"data": "bot_ref"},
                    {"data": "create_dt"},
                    {"data": "expires_dt"},
                    {"data": "nb_of_rec"},
                    {
                        "data": "msg_id",
                        "render": function (data, type, row, meta) {
                            var a = '<button type="button" class="btn btn-primary" onclick="previewAccounts(\'';
                            a += row.id + '\',\'' + row.msg_id + '\',\'' + row.nb_of_rec + '\',\'' + userRoles;
                            a += '&nbsp;<button type="button" class="btn btn-primary" onclick="viewAttachments(\'';
                            a += row.msg_id + '\')">View Attachments</button>';
                            return a;
                        }
                    }
                ], aoColumnDefs: [
                    {
                        bSortable: false,
                        aTargets: [-1],
                    }
                ],
                buttons: [{
                        extend: "copy",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "csv",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "excel",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "pdf",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }, {
                        extend: "print",
                        title: 'MoFP ACCOUNTS REPORT',
                        className: "btn-sm",
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    }
                ]
            });
            reportTable.on('order.dt search.dt', function () {
                reportTable.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();

            //load the tab content
            $('[data-toggle="tab"]').click(function (e) {
                var $this = $(this),
                target = $this.attr('data-target');
                if (target == '#workflowTabContent') {
                    $("#reportTabContent").hide();
                    $("#manageAccountsTabContent").hide();
                    $("#workflowTabContent").show();
                    reloadWorkflowDatatable();
                } else if (target == '#manageAccountsTabContent') {
                    $("#reportTabContent").hide();
                    $("#workflowTabContent").hide();
                    $("#manageAccountsTabContent").show();
                    reloadAccountsDatatable();
                } else {
                    $("#workflowTabContent").hide();
                    $("#manageAccountsTabContent").hide();
                    $("#reportTabContent").show();
                    reloadReportDatatable();
                }
            });
        });

        function reloadWorkflowDatatable() {
            $('#paymentReport').empty();
            $('#downloadReport').hide();
            $('#accountsWorkflow').DataTable().ajax.reload();
            $('#accountsWorkflow').DataTable().columns.adjust();
        }

        function reloadAccountsDatatable() {
            $('#govInstAcctTable').DataTable().ajax.reload();
            $('#govInstAcctTable').DataTable().columns.adjust();
        }

        function reloadReportDatatable() {
            $('#accountsReport').DataTable().ajax.reload();
            $('#accountsReport').DataTable().columns.adjust();
        }

        function download(batchReference) {
            var formData = new FormData();
            formData.append("batchReference", batchReference);
            formData.append("reportFormat", "pdf");
            $("#loading").show();
            $.ajax({
                url: "/getMUSEReport",
                type: 'POST',
                data: formData,
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                success: function (res) {
                    $("#loading").hide();
                },
                error: function (res) {
                    $("#loading").hide();
                    $("#successFlag").html('<div class="alert alert-danger" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close">x</button><strong>' + res.message + res.result + '</strong></div>').show();
                    console.log(res);
                }
            })
        }
    </script>
</div>
</body>
</html>
