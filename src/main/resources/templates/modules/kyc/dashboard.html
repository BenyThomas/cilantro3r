<div layout:fragment="pageStyle" th:remove="tag" xmlns:layout="http://www.w3.org/1999/xhtml"
     xmlns:th="http://www.w3.org/1999/xhtml">
  <link th:href="@{/assets/plugins/bootstrap-tagsinput/css/bootstrap-tagsinput.css}" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/assets/plugins/switchery/switchery.min.css}">
  <link th:href="@{/assets/plugins/select2/css/select2.min.css}" rel="stylesheet" type="text/css" />
  <link th:href="@{/assets/plugins/timepicker/bootstrap-timepicker.min.css}" rel="stylesheet">
  <link th:href="@{/assets/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css}" rel="stylesheet">
  <link th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}" rel="stylesheet">
  <link th:href="@{/assets/plugins/clockpicker/css/bootstrap-clockpicker.min.css}" rel="stylesheet">
  <link th:href="@{/assets/plugins/bootstrap-daterangepicker/daterangepicker.css}" rel="stylesheet">
  <style>
    .bg-midnight-bloom {
      background-image: linear-gradient(-20deg,#2b5876 0%,#4e4376 100%)!important;
    }
    .bg-arielle-smile {
      background-image: radial-gradient(circle 248px at center,#16d9e3 0%,#30c7ec 47%,#46aef7 100%)!important;
    }
    .bg-grow-early {
      background-image: linear-gradient(to top,#0ba360 0%,#3cba92 100%)!important;
    }
    .widget-content {
      padding: 1rem;
      flex-direction: row;
      align-items: center;
    }
    .widget-content .widget-content-wrapper {
      display: flex;
      flex: 1;
      position: relative;
      align-items: center;
    }
    .text-white {
      color: #fff!important;
    }
    .widget-content .widget-content-left .widget-heading {
      opacity: .8;
      font-weight: 700;
    }
    .widget-content .widget-content-left .widget-subheading {
      opacity: .5;
    }
    .widget-content .widget-content-right {
      margin-left: auto;
    }
    @media (max-width: 991.98px)
    .widget-content .widget-numbers {
      font-size: 1.6rem;
      line-height: 1;
    }
    .widget-content .widget-numbers {
      font-weight: 700;
      font-size: 1.8rem;
      display: block;
    }
    .btn-primary {
      color: #fff;
      background-color: #3f6ad8;
      border-color: #3f6ad8;
    }
  </style>
</div>
<div class="container" layout:fragment="contents">
  <div class="row">
    <div class="col-md-4 col-xl-4">
      <div class="card mb-3 widget-content bg-midnight-bloom">
        <div class="widget-content-wrapper text-white">
          <div class="widget-content-left">
            <div class="widget-heading">New NIDA accounts</div>
            <div class="widget-subheading">This year</div>
          </div>
          <div class="widget-content-right">
            <div class="widget-numbers text-white"><span th:text="${nidaAccounts}"/></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-4">
      <div class="card mb-3 widget-content bg-arielle-smile">
        <div class="widget-content-wrapper text-white">
          <div class="widget-content-left">
            <div class="widget-heading">New Non-NIDA accounts</div>
            <div class="widget-subheading">This year</div>
          </div>
          <div class="widget-content-right">
            <div class="widget-numbers text-white"><span th:text="${nonNidaAccounts}"/></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-xl-4">
      <div class="card mb-3 widget-content bg-grow-early">
        <div class="widget-content-wrapper text-white">
          <div class="widget-content-left">
            <div class="widget-heading">Total accounts</div>
            <div class="widget-subheading">This year</div>
          </div>
          <div class="widget-content-right">
            <div class="widget-numbers text-white"><span th:text="${totalAccounts}"/></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row" style="margin: 10px -10px 10px -10px">
    <div class="col-md-6 col-xl-4">
      <button type="button" class="btn btn-primary btn-sm" onclick="window.open('/api/getSuccessAccountsReport', '_blank');">Print successful accounts this year</button>
    </div>
  </div>
  <div class="row">
    <div class="panel panel-default panel-fill"><div class="panel-heading">
      <h4 class="panel-title" th:text="${pageTitle}"></h4></div>
      <div class="panel-body">
        <form role="form" id="kycReportForm">
          <div class="row flex-row">
            <div class="form-group col-md-3">
              <div class="input-group">
                <input id="fromDate" name="fromDate" class="form-control form-control-inline input-txndatemedium default-date-picker" data-date-format="yyyy-mm-dd" type="text" placeholder="From Date" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-calendar"></i></span>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-3">
              <div class="input-group">
                <input id="toDate" name="toDate" class="form-control form-control-inline input-txndatemedium default-date-picker" data-date-format="yyyy-mm-dd" type="text" placeholder="To Date" autocomplete="off"/>
                <span class="input-group-addon"><i class="mdi mdi-calendar"></i></span>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-2">
              <div class="input-group">
                <select class="form-control col-sm-12 select2" id="reportType" name="reportType" style="font-size: 10px !important;">
                  <option value="">Select Report Type</option>
                  <option value="General">GENERAL</option>
                  <option value="Categorized">CATEGORIZED</option>
                </select>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-2">
              <div class="input-group col-sm-12">
                <select class="form-control select2" id="format" name="format" style="font-size: 10px !important;">
                  <option value="">Report Format</option>
                  <option value="preview">PREVIEW</option>
                  <option value="pdf">PDF</option>
                  <option value="excel">EXCEL</option>
                  <option value="csv">CSV</option>
                  <option value="word">WORD</option>
                  <option value="html">HTML</option>
                </select>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-2" style="margin-top: auto; margin-bottom: auto;">
              <button type="button" class="btn btn-primary btn-submit" onclick="getKYCReport()">Search</button>
            </div>
          </div>
          <div class="row flex-row">
            <div class="form-group col-md-2">
              <div class="input-group">
                <select class="form-control col-sm-12 select2" id="branch" name="branch" style="font-size: 10px !important;">
                  <option value="">Select Branch</option>
                  <option th:each="branch: ${branches}" th:value="${branch.code}" th:text="${branch.name}"></option>
                </select>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-2">
              <div class="input-group col-sm-12">
                <select class="form-control select2" id="is_agent" name="is_agent" style="font-size: 10px !important;">
                  <option value="">Agent Type</option>
                  <option value="0">TCB Champion</option>
                  <option value="1">TCB Wakala</option>
                  <option value="2">Mainstream</option>
                </select>
              </div><!-- input-group -->
            </div>
            <div class="form-group col-md-2">
              <div class="input-group col-sm-12">
                <select class="form-control select2" id="agent" name="agent" style="font-size: 10px !important;"></select>
              </div><!-- input-group -->
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="row" style="margin: 20px 0;">
    <div class="col-md-12">
      <div class="card" style="flex-direction: inherit; box-shadow: 0 0 10px 0 rgba(100, 100, 100, 0.26);">
        <div class="card-body">
          <h5 class="card-title">NO OF REMOTE ACCOUNTS BY BRANCH</h5>
          <div id="branches-chart" style="height: 300px;"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="row" style="margin: 20px 0;">
    <h4>Pending branches <span th:text="${#lists.size(pendingBranches)}"/></h4>
    <ul class="list-group">
      <li class="list-group-item" th:each="pendingBranch: ${pendingBranches}">
        <span th:text="${pendingBranch.name}"></span>
      </li>
    </ul>
  </div>
</div>
<div layout:fragment="pageScript" th:remove="tag">
  <script th:src="@{/assets/plugins/bootstrap-tagsinput/js/bootstrap-tagsinput.min.js}"></script>
  <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
  <script th:src="@{/assets/plugins/bootstrap-filestyle/js/bootstrap-filestyle.min.js}" type="text/javascript"></script>
  <script th:src="@{/assets/plugins/switchery/switchery.min.js}"></script>
  <script th:src="@{/assets/plugins/parsleyjs/parsley.min.js}" type="text/javascript"></script>
  <script th:src="@{/assets/plugins/moment/moment.js}"></script>
  <script th:src="@{/assets/plugins/timepicker/bootstrap-timepicker.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
  <script th:src="@{/assets/plugins/clockpicker/js/bootstrap-clockpicker.min.js}"></script>
  <script th:src="@{/assets/plugins/bootstrap-daterangepicker/daterangepicker.js}"></script>
  <script th:src="@{/assets/plugins/flot-chart/jquery.flot.min.js}"></script>
  <script th:src="@{/assets/plugins/flot-chart/jquery.flot.resize.js}"></script>
  <script type="text/javascript" th:inline="javascript">
      let report = JSON.parse(/*[[${branchesReport}]]*/);
      $(document).ready(function () {
          var previousPoint = null;
          var dataArr = [];
          var ticks = [];
          $('#fromDate, #toDate').datepicker({
              autoclose: true,
              todayHighlight: true
          });
          $.fn.UseTooltip = function () {
              $(this).bind("plothover", function(event, pos, item) {
                  if (item) {
                      if (previousPoint != item.dataIndex) {
                          previousPoint = item.dataIndex;

                          $("#tooltip").remove();

                          var x = item.datapoint[0];
                          var y = item.datapoint[1];

                          showTooltip(item.pageX, item.pageY, categories[x][1] + "<br/>" + "<strong>" + y.toLocaleString('sw-TZ') + "</strong>");
                      }
                  } else {
                      $("#tooltip").remove();
                      previousPoint = null;
                  }
              });
          };
          report.forEach(function (item, index) {
              dataArr.push([index, item.count]);
              ticks.push([index, item.name]);
          })
          categories = ticks;
          categoryOption = 'count';
          var bar_data = [{
              data: dataArr,
              bars: { show: true }
          }]
          $.plot('#branches-chart', bar_data, {
              grid: {
                  borderWidth: 1,
                  borderColor: '#f3f3f3',
                  tickColor  : '#f3f3f3',
                  hoverable: true
              },
              series: {
                  bars: {
                      show: true, barWidth: 0.5, align: 'center', lineWidth: 0, fill: true,
                  },
              },
              colors: ['#3BA03E','#1ECBE1','#E1341E','#F20D6E','#0DF291','#E5CB1A'],
              xaxis: {
                  mode: "categories",
                  ticks: ticks,
              }
          });
          $('#branches-chart').UseTooltip();

          $('#agent').select2({
              placeholder: 'Type agent username/account',
              ajax: {
                  url: '/api/autocompleteUser',
                  dataType: 'json',
                  delay: 250,
                  data: function (data) {
                      return {
                          searchTerm: data.term
                      };
                  },
                  processResults: function (response) {
                      return {
                          results: response
                      };
                  },
                  cache: true
              }
        });
      })

      function showTooltip(x, y, contents) {
          $('<div id="tooltip">' + contents + '</div>').css({
              position: 'absolute',
              display: 'none',
              top: y + 5,
              left: x + 20,
              border: '2px solid #4572A7',
              padding: '2px',
              size: '10',
              'border-radius': '6px 6px 6px 6px',
              'background-color': '#fff',
              opacity: 0.80
          }).appendTo("body").fadeIn(200);
      }

      function getKYCReport() {
          var formData = new FormData($('#kycReportForm')[0]);
          var agent = "";
          if (formData.get("agent") !== null) {
            agent = formData.get("agent");
          }
          window.open("/getKYCReports?fromDate="+
          formData.get("fromDate")+"&toDate="+formData.get("toDate")+"&reportType="+formData.get("reportType")+
          "&format="+formData.get("format")+"&branch="+formData.get("branch")+"&agent="+agent+"&is_agent="+
          formData.get("is_agent"), "_blank");
      }
  </script>
</div>