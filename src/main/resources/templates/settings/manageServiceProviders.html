<html layout:decorate="~{fragments/main_layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Manage Service Providers</title>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

</head>
<body>
<div layout:fragment="pageStyle" th:remove="tag">
    <style>
                #loading {
                    background: url('/assets/images/ajax-loader.gif') no-repeat center center;
                    position: absolute;
                    top: 0;
                    left: 0;
                    height: 92%;
                    width: 100%;
                    z-index: 9999999;
                }
                .btn{
                    border-radius: 0px !important;
                }
                .btn-dark {
                    background-color: #107f13!important;
                    border: 1px solid #ffffff!important;
                }


    </style>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/jquery.dataTables.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/buttons.bootstrap.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/responsive.bootstrap.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/scroller.bootstrap.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/dataTables.colVis.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/dataTables.bootstrap.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/datatables/fixedColumns.dataTables.min.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}">
    <link rel="stylesheet" th:href="@{/assets/plugins/select2/css/select2.min.css}" type="text/css"/>
</div>
<div class="container" layout:fragment="contents">
    <div class="table-responsive">
        <div class="panel panel-default panel-fill" id="tabContentsss">
            <div class="panel-heading"><h4 class="panel-title">MANAGE SERVICE PROVIDERS(SP)</h4> <a class="btn btn-primary pull-right" id="addNewSericeProvider" style="background-color: #750a0a !important; border: 1px solid #b1e401 !important;margin-top: -22px !important;">New Service Provider </a></div>
            <div class="panel-body">
                <div id="editPermission"></div>
                <div class="col-md-12" id="successFlag"></div>
                <div hidden id="addNewServiceProverForm">
                    <form class="form-horizontal" id="addNewServiceProverF" role="form">
                        <table class="table table-striped table-bordered"
                               style="width: 100%; font-size: 8.5px !important;">
                            <tbody>
                            <tr>
                                <td>SP Name</td>
                                <td><input autocomplete="off" class="form-control form-control-sm" id="permissionName"
                                           name="spName"
                                           placeholder="Service Provider name" style="font-size: 10px !important;"
                                           type="text"></td>
                                <td>SP Address</td>
                                <td><input autocomplete="off" class="form-control form-control-sm" id="spAddress"
                                           name="spAddress"
                                           placeholder="Address" style="font-size: 10px !important;"
                                           type="text"></td>
                            </tr>
                            <tr>
                                <td>SP Phone</td>
                                <td><input autocomplete="off" class="form-control form-control-sm" id="permissionUrl1"
                                           name="spPhone" placeholder="SP phone number"
                                           style="font-size: 10px !important;" type="text"></td>
                                <td>SP Account</td>
                                <td><input autocomplete="off" class="form-control form-control-sm" name="spBankAccount"
                                           placeholder="SP account Number" style="font-size: 10px !important;"
                                           type="text"></td>
                            </tr>
                            <tr>
                                <td>SP Bank</td>
                                <td><select class="form-control select2" id="spBankSwiftCode" name="spBankSwiftCode"
                                            style="font-size: 10px !important;width: 328px !important;">
                                    <option value="">Select destination Bank</option>
                                    <option th:each="bank: ${banks}" th:text="${bank.name+'['+bank.swift_code+']'}"
                                            th:value="${bank.swift_code+'=='+bank.identifier}"> ATM
                                    </option>
                                </select>
                                    <div id="intermediary">

                                    </div>
                                </td>
                                <td>Service Provided by SP</td>
                                <td><textarea autocomplete="off" class="form-control form-control-sm" name="spFacility"
                                              placeholder="facility Description"
                                              style="font-size: 10px !important;"></textarea></td>
                            </tr>
                            </tbody>
                        </table>
                        <button class="btn btn-primary save-service-provider" type="button">Save Service Provider
                        </button>
                    </form>
                </div>

<!--                <div class="row"><a class="btn btn-primary pull-right" id="addNewSericeProvider">New Service-->
<!--                    Provider</a></div>-->
                <div class="row">
                    <table class="display nowrap table table-striped table-bordered" id="serviceProvidersTable"
                           style="width: 100%; font-size: 8.5px !important;">
                        <thead>
                        <tr>
                            <th>S/N</th>
                            <th>Provider Name</th>
                            <th>Provider Address</th>
                            <th>Provider Phone</th>
                            <th>Bank Code</th>
                            <th>Bank Account</th>
                            <th>Identifier</th>
                            <th>Service Description</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <!--</form>-->
                </div>
            </div>

        </div>


    </div>
</div> <!-- container -->

<!--</body>-->
<div layout:fragment="pageScript" th:remove="tag">
    <script th:src="@{/assets/plugins/datatables/jquery.dataTables.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.bootstrap.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.buttons.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/jszip.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/pdfmake.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/vfs_fonts.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.html5.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/buttons.print.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.keyTable.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.responsive.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/responsive.bootstrap.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.scroller.min.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.colVis.js}"></script>
    <script th:src="@{/assets/plugins/datatables/dataTables.fixedColumns.min.js}"></script>
    <!--init-->
    <script th:src="@{/assets/pages/jquery.datatables.init.js}"></script>
    <!--App Js-->
    <script th:src="@{/assets/js/jquery.app.js}"></script>
    <script th:src="@{/assets/plugins/select2v4/select2.min.js}"></script>
    <script th:src="@{/assets/plugins/select2/js/select2.min.js}" type="text/javascript"></script>
    <script th:src="@{/assets/scripts/sprovider.js}"></script>
    <script type="text/javascript">
                $(document).ready(function () {
                    $('.select2').select2();
                    $("#loading").hide();
                    $("#loading2").hide();

                    $('#addNewSericeProvider').click(function () {
                        $('#addNewServiceProverForm').toggle('slide');
                    });

                     $('.select2').select2({
                        theme:'classic',
                        height:'80%',
                        width:'100%'
                     });

                    $("#mno").on('change', function () {
                        $('#serviceProvidersTable').DataTable().ajax.reload();
                    });
                    var token = $("meta[name='_csrf']").attr("content");
                    var header = $("meta[name='_csrf_header']").attr("content");
                    var b = 1;
                    var i = 0;
                    var table = $('#serviceProvidersTable').DataTable({
                        dom: 'Blfrtip',
                        scrollY: "300px",
                        scrollX: true,
                        lengthChange: true,
                        pageLength: 10,
                        lengthMenu: [
                            [10, 25, 50, 100, 500, -1],
                            [10, 25, 50, 100, 500, 'Show all']
                        ],
                        responsive: false,
                        processing: true,
                        serverSide: true,
                        serverMethod: 'post',
                        order: [2, "desc"],
                        ajax: {
                            'url': '/getServiceProvidersAjax',
                            'beforeSend': function (request) {
                                request.setRequestHeader(header, token);
                            },
//                            "data": function (d) {
//                                return $.extend({}, d, {
////                                    "mno": $("select[name='mno']").val()
//                                });
//                            }
                        },
                        "columns": [
                            {"data": "id"},
                            {"data": "name"},
                            {"data": "address"},
                            {"data": "phone"},
                            {"data": "bank_swiftcode"},
                            {"data": "bank_account"},
                            {"data": "identifier"},
                            {"data": 'facility_description'},
                            {"data": 'id',
                                "orderable": false,
                                "searchable": false,
                                "render": function (data, type, row, meta) {
                                    a = '<button class="btn btn-primary" onclick="previewEditSProvider(\'' + row.id + '\')">Edit</button>';
                                    return a;
                                }}

                        ], aoColumnDefs: [
                            {
                                bSortable: false,
                                aTargets: [-1]
                            }
                        ], buttons: [{
                                extend: "copy",
                                title: 'Service Providers Lists',
                                className: "btn-sm"
                            }, {
                                extend: "csv",
                                title: 'Service Providers Lists',
                                className: "btn-sm"
                            }, {
                                extend: "excel",
                                title: 'Service Providers Lists',
                                className: "btn-sm"
                            }, {
                                extend: "pdf",
                                title: 'Service Providers Lists',
                                className: "btn-sm"
                            }, {
                                extend: "print",
                                title: 'Service Providers Lists',
                                className: "btn-sm"
                            }],
                        "preDrawCallback": function (settings) {
                            if ($("select[name='mno']").val() == '') {
                                return false;
                            }
                        }
                    });
                    table.on('order.dt search.dt', function () {
                        table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                            cell.innerHTML = i + 1;
                        });
                    }).draw();


                    /*
                     * SAVE SERVICE PROVIDER ON DATABASE
                     */
                    $('.save-service-provider').click(function (e) {
                        var formdata = new FormData($('#addNewServiceProverF')[0]);
                        $.ajax({
                            url: "/addServiceProvider",
                            type: 'POST',
                            data: formdata, //{senderAccount: senderAccount, senderName: senderName, senderAddress: senderAddress, amount: amount, currency: currency, beneficiaryName: beneficiaryName, beneficiaryBIC: beneficiaryBIC, description: description, supporting_doc: supporting_doc, beneficiaryAccount: beneficiaryAccount},
                            enctype: 'multipart/form-data',
                            processData: false,
                            contentType: false,
                            success: function (res) {
                                $('.error').html('');
                                if (res.validated) {
                                    $('#preloader2').hide();
                                    $("#successFlag").html('<div class="alert alert-success" role="alert" id="successFlag"><button type="button" class="close" data-dismiss="alert"asuccessFlagria-label="Close"> </button><strong>Service provider Added Successfuly</strong></div>');
                                    $('#serviceProvidersTable').DataTable().ajax.reload();
                                    $('#addNewServiceProverForm').hide();
                                } else {
                                    $('#preloader2').hide();
                                    $.each(res.errorMessages, function (key, value) {
                                        $('Select[name=' + key + ']').after('<span class="error" style="color:red">' + value + '</span>');
                                        $('input[name=' + key + ']').after('<span class="error" style="color:red">' + value + '</span>');
                                        $('textarea[name=' + key + ']').after('<span class="error" style="color:red">' + value + '</span>');

                                    });
                                }
                            }
                        });
                    });
                    /*
                     * IDENTIFY THE COMPANY AS LOCAL OR INTERNATIONAL
                     */
                    $("#spBankSwiftCode").on('change', function () {
                        var benBic = $("select[name='spBankSwiftCode']").val();
                        var identifier = benBic.split('==');
                        if (identifier[1] === 'INTERNATIONAL') {
                            /*
                             * ADD AN INPUT FOR INTERMEDIARY SWIFT CODE
                             */
                            $('#intermediary').append('<input type="text" id="intermediaryBank" name="intermediaryBank" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');
                            $('#intermediary').append('<input type="text" id="identifier" name="identifier" readonly="" hidden="" autocomplete="off" value="INTERNATIONAL" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');

                        }
                        if (identifier[1] === 'EAPS') {
                            /*
                             * ADD AN INPUT FOR INTERMEDIARY SWIFT CODE
                             */
                            $('#intermediary').append('<input type="text" id="intermediaryBank" name="intermediaryBank" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');
                            $('#intermediary').append('<input type="text" id="identifier" name="identifier" readonly="" hidden="" autocomplete="off" value="INTERNATIONAL" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');

                        }
                        if (identifier[1] === 'LOCAL') {
                            /*
                             * ADD AN INPUT FOR INTERMEDIARY SWIFT CODE
                             */
                            $('#intermediary').append('<input type="text" hidden="" readonly="" id="identifier" name="identifier" value="LOCAL" autocomplete="off" class="form-control form-control-sm" style="font-size: 10px !important;" placeholder="Intermediary Bank Swift Code (IF APPLICABLE)">');

                        }
                    });
                });
                function  editPermission(id) {
                    $.ajax({
                        url: "/editRole",
                        data: {role_id: id},
                        type: 'GET',
                        success: function (res) {
                            console.log(res);
                            $("#editRole").toggle('slide').html(res).return;
//                            ("#loading").hide();

                        }
                    });
                }



    </script>
</div>

</html>
